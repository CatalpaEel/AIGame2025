# 大信科活动规划与宣传智能系统

信息科学技术学院经常需要策划和举办各类学术讲座、科研竞赛、行业交流等活动。本系统借助Deepseek、豆包等大模型API，能够在一次性输入活动初步需求后，自动完成活动策划案、各种宣传稿以及主视觉的生成。

## 一、架构设计与Agent设计

系统总共有12个Agent，可以分为输入解析、活动设计、历史文案分析、宣传文案生成、历史主视觉分析、主视觉生成六大模块。

<center>
    <img style="border-radius: 0.3125em;" src="workflow.drawio.png">
    <div style="color: #999;">系统整体架构与Agent分工</div>
</center>

### 输入解析

根据用户输入，解析出若干特征：活动类型、主题方向、初步构想、活动目的、活动规模、时间安排、活动地点、可能的合作方等。

我们还使用检索增强（RAG）技术获取历史活动的信息加以补充。

### 活动设计

根据解析出的输入特征，设计详细的活动策划案，包括活动流程和时间安排建议等。如果是竞赛类活动，还会详细设计合理的赛题、规则与评分标准。

### 历史文案分析

我们使用检索增强技术进行分析。首先进行数据清理：将docx文件转txt文件、去除空行、调用Deepseek进一步清理等。然后进行切分和嵌入（Embedding），生成向量知识库，供输入解析模块调用。

### 宣传文案生成

宣传文案共有四个部分：微信公众号推送稿、邮件通知版本、短文本宣传语、社交媒体分享版本。每个部分都有一个专门的Agent，根据活动策划案来生成。

### 历史主视觉分析

对历史主视觉数据集进行分析，提炼大信科主视觉的艺术特点，从而增强主视觉生成的风格一致性。由于主视觉生成是基于提示词（prompt）的，因此提炼过去主视觉的特点，可直接通过“反推提示词”来实现。所以，本模块的任务是，对数据集中每一个主视觉图片，经预处理后调用API，让大模型反推出生成该图片的可能的提示词，并储存下来备用。

### 主视觉生成

首先根据本次活动的特征以及历史主视觉分析得出的数据，使用Deepseek生成提示词，再根据提示词通过文生图模型生成主视觉。

## 二、API调用策略与参数设计

### 检索增强

检索增强能根据输入信息，从知识库里检索出最相近的信息，用于知识补充。除比赛网站提供的数据集外，我们还自己搜寻了一些活动数据，经过数据清理，用于后续嵌入。由于时间紧迫，在简单地预处理之后，我们直接使用Deepseek-Chat模型来进行数据清理。之后我们运用LangChain框架，对数据进行切分，然后我们使用豆包的[Embedding模型](https://www.volcengine.com/docs/82379/1521766)进行向量化，最后存到Chroma数据库里。

### 活动策划

活动策划对逻辑性、丰富性都有较高的要求，因此我们选择使用[Deepseek-R1模型](https://api-docs.deepseek.com/zh-cn/guides/reasoning_model)。使用推理模型后，生成的质量有了明显提高，但后果是极大增大了耗时，使得该步骤成为了系统的时间瓶颈。

### 文案生成

文案生成只需要基于详细的活动策划案，选取关键信息，调整风格特点。我们选择使用[Deepseek-V3模型](https://api-docs.deepseek.com/zh-cn/)来满足需求。

为了使生成文案的风格特点更符合预期，我们为还寻找或构造了四个例子，写入提示词里，分别作为四个Agent的参考。

### 历史主视觉分析

由于需要输入图片并分析图片，我们使用了豆包的视觉理解大模型[doubao-1-5-vision-pro-32k-250115](https://www.volcengine.com/docs/82379/1494384)。调用方法为[OpenAI API](https://www.volcengine.com/docs/82379/1330626)。

豆包API在处理不同格式的图片（jpg、png）时有细微的差别，为了方便，我们先通过代码将数据集批量转化成了png格式。豆包还要求上传图片的大小不超过25M，超过这个大小的图片不多，于是我们使用Windows画图软件手动调整了大小。

在系统提示词（system prompt）里，需强调中文输出与不输出多余信息，否则可能会生成英文提示词或带上“以下是可能的文生图提示词”的多余前缀。

### 文生图模型的选择

目前较为先进的开源文生图模型有Flux.1与StableDiffusion3.5等，但这两个模型都是基于英语训练的，极难做好对中文字符的生成。然而，主视觉的重要目的是传达核心信息，清晰明显的字体是主视觉可用性的重要保障，而英文标题的主视觉又不符合大信科的风格，因此中文字符生成的质量是模型选择的关键。总之，Flux.1与StableDiffusion3.5模型不适宜直接用作主视觉的生成。

于是，我们尝试在Flux.1的基础上添加ControlNet来实现中文字符的正确生成。首先使用Pillow库，设计文字坐标生成文字底图（textbase），然后将文字底图输入ControlNet，经过硬边缘预处理，提取出文字的轮廓，引导模型生成。

我们使用LiblibAI提供的[api接口](https://liblibai.feishu.cn/wiki/UAMVw67NcifQHukf8fpccgS5n6d#OU4KdR29zoAieyxj8EicICJ5nmg)，选择F.1-dev-fp8底模与InstantX-FLUX.1-dev-Controlnet-Union-Pro模型。最终，我们取得了一定的效果。

<center style="display:flex; gap: 5%;">
    <center>
        <img src="image_flux.png">
        <div style="color: #999;">Flux.1生成的主视觉</div>
    </center>
    <center>
        <img src="image_controlnet.png">
        <div style="color: #999;">Flux.1+ControlNet</div>
    </center>
</center>

然而，这种方法有几个明显的缺点：1.调用Pillow库前，需要精准计算文字底图上文字的坐标，但大模型很难生成这样精准的坐标位置；2.底图经过预处理器后仅有文字边缘，导致除文字外的部分很难生成硬边缘，只能产生诸如水彩的模糊风格。3.字体有限，难以生成艺术字；4.较小的文字仍然会变形。

因此，我们最后转向一些国内的闭源模型。经测试，字节跳动的[通用2.1-文生图](https://www.volcengine.com/docs/6791/1366783)和[即梦V2.1文生图模型](https://www.volcengine.com/docs/85621/1537648)都有一定的中文字符生成能力。（实际上不确定这两个产品是否同一个模型。另外，3.0版本已经发布，可以在网页版使用，对中文字符的生成能力更佳，但API调用接口似乎并未开放。）我们最后使用的是即梦V2.1文生图模型，通过[火山引擎SDK](https://www.volcengine.com/docs/6444/1340578)调用。

### 文生图提示词生成

由于豆包文生图对输入文字有严格的审核机制，该Agent生成的提示词必须尽量绕开豆包审核。经测试，审核不通过的主要原因是提示词里出现了“北京大学”的字样，因为这可能会产生虚假新闻或版权争议。因此，我们必须在该Agent的prompt里强调“不要出现‘北京大学’等现实中的名称”。

由于多线程中，活动设计的时间远远长于文生图的线程（使用Deepseek-Chat时），因此我们也将提示词生成的模型改为了Deepseek-Reasoner，以求在不损害系统效率的前提下提高生成质量。

## 三、风格分析与特征提取方法论

### 主视觉数据集分析

起初我们简单地把数据集中的图片交给视觉理解大模型分析，提取文字信息、背景元素、艺术风格、排版形式、配色等特征，然后再让大模型总结。然而，这样的做法严重丢失了源数据集的信息，噪声极大，最后的总结数据几乎没有参考价值。

于是，我们采用“反推提示词”的方法，将数据集图片直接转化为提示词，很好地保留了图片的信息。我们也放弃了总结的步骤，直接将若干提示词作为参考交给负责生成prompt的Agent。

## 四、性能优化与评估

可以发现，系统的一些模块具有明显的并行性。因此，我们使用python提供的多线程库，使得总时间仅为Agent累计时间的约50%。

最后，我们统计了各Agent的耗时以及系统的总耗时。

|测试内容|输入分析|活动策划|微信公众号推送稿|邮件通知|短文本宣传语|社交媒体文案|文生图提示词|主视觉生成|总时间|
|-|-|-|-|-|-|-|-|-|-|
|AI挑战赛|9.94|86.92|21.79|23.32|5.14|30.87|35.50|8.34|128.07|
|户外徒步|19.73|87.80|36.97|29.02|13.42|30.29|63.94|6.50|150.18|
|电脑维修|20.52|81.71|27.13|27.95|13.64|23.85|56.92|8.30|136.23|
|植树活动|16.49|87.00|22.96|25.09|7.93|19.37|62.76|8.07|128.83|
<center style="color: #999;">不同活动类型下各模块的耗时统计（单位：秒）</center>

## 五、质量评估与改进方向

### 活动策划案

由于使用了推理模型，活动策划有一定的丰富性。然而，活动策划里仍会出现一些事实性错误，例如学院名称错误等。如果要继续改进，可考虑使用RAG技术。

### 文案生成

由于生成的案例是直接编码到system prompt里面的，所以输出结果也高度类似于提供的这一个案例。一方面这使得风格大体符合预期，另一方面又使得风格灵活性较差。这部分的改进也可以考虑使用检索增强技术。

### 主视觉生成

主视觉生成，最明显的缺点就是中文字符生成变形，以及风格与大信科迥异。前者可以寄希望于更先进的大模型，后者可以通过扩充文生图提示词、提供参考等方法来改进。

## 六、参考资料

### API 文档

[Deepseek-V3文档](https://api-docs.deepseek.com/zh-cn/)

[Deepseek-R1文档](https://api-docs.deepseek.com/zh-cn/guides/reasoning_model)

[LiblibAI文档](https://liblibai.feishu.cn/wiki/UAMVw67NcifQHukf8fpccgS5n6d)

[豆包通用2.1-文生图文档](https://www.volcengine.com/docs/6791/1366783)

[即梦V2.1文生图模型文档](https://www.volcengine.com/docs/85621/1537648)

[火山引擎SDK文档](https://www.volcengine.com/docs/6444/1340578)

[豆包接入OpenAI API文档](https://www.volcengine.com/docs/82379/1330626)

[豆包Embedding模型文档](https://www.volcengine.com/docs/82379/1521766)

### Prompt构造参考

[Deepseek提示库](https://api-docs.deepseek.com/zh-cn/prompt-library/)

[火山引擎Prompt最佳实践](https://www.volcengine.com/docs/82379/1221660)

### 学习资料

[Flux.1教程](https://www.fluxai.cn/detail/practical-guide-to-the-ultimate-flux1-20240915)

[ControlNet教程](https://blog.csdn.net/text2203/article/details/144979415)

[ControlNet文字嵌入](https://zhuanlan.zhihu.com/p/643811027)

[豆包RAG教程](https://juejin.cn/post/7468144197293473827)

### 工具

[图片转Prompt](https://imageprompt.org/zh/image-to-prompt)

[流程图绘制](https://www.drawio.com/)